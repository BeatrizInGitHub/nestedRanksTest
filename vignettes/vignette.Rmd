---
title: "Using nestedRanksTest"
author: "Douglas G. Scofield"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using nestedRanksTest}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", fig.show = "hold")
```

# Background

Together with my colleagues Pamela Thompson, Peter Smouse and Victoria Sork, we
were examining year-to-year differences in acorn movement by acorn woodpeckers
in an oak savannah in central California.  Drs Sork and Smouse have
collaborated for several years studying patterns of genetic diversity in oak
populations, unraveling the ways in which genetic diversity moves around the
landscape via dispersal of pollen and seeds.  This usually involves the
development of analytic methods to help study patterns of dispersal. 

[Acorn woodpeckers (*Melanerpes formicivorus*)][KoenigMumme] are highly social
and highly territorial, with each social group maintaining its own granary in
which it stores up to thousands of acorns.  [Granaries][GranaryImageSearch] are
constructed by the woodpeckers; they drill many closely spaced holes into bark
or wood which they fill during times of acorn production.  In our study site,
granaries are nearly always constructed in the thick bark of [valley oak
(*Quercus lobata*)][ValleyOak], while acorns were harvested from both valley
oak and [coast live oak (*Quercus agrifolia*)][LiveOak].  Coast live oaks have
darker-green canopies in the picture below, while live oaks have lighter-green
canopies.

![Figueroa valley, Sedgwick Natural Reserve, Santa Barbara County, California](sedgwick_landscape_fewtrees.jpg "Figueroa valley, Sedgwick Natural Reserve, Santa Barbara County, California")

Oaks are [mast-seeding][MastSeeding] species; their acorn production can vary a
great deal from year to year.  One of the questions we asked during our
year-to-year comparisons was: Do woodpeckers forage for acorns farther from
their granaries during years of low acorn production?  This is a common-sense
prediction from [optimal foraging theory][OptimalForagingTheory]; if there is
food available close to home, why travel far?  In years of high acorn
production, acorns tend to be readily available throughout the landscape, but
time and energy are saved by foraging from trees closer to the granary.  When
acorn production is low, more travel is required to find acorns, and
woodpeckers are likely to gather acorns from trees that are on average farther
away from their granaries.

[KoenigMumme]: http://www.amazon.com/gp/product/0691084645/ref=as_li_tl?tag=itsbadnindeof-20
[GranaryImageSearch]: https://www.google.com/search?q=acorn+woodpecker+granaries&num=100&newwindow=1&hl=en&tbm=isch
[ValleyOak]: http://en.wikipedia.org/wiki/Quercus_lobata
[LiveOak]: http://en.wikipedia.org/wiki/Quercus_agrifolia
[MastSeeding]: http://www.hastingsreserve.org/oakstory/AmerSciMastKoenig_05.pdf
[OptimalForagingTheory]: http://en.wikipedia.org/wiki/Optimal_foraging_theory


# Initial analyses

First, we prepare our datasets and generate tables to see how big our sample
sizes are.

```{r}
library(nestedRanksTest)
data(woodpecker_multiyear)
d.Qlob <- subset(woodpecker_multiyear, Species == "lobata")
d.Qagr <- subset(woodpecker_multiyear, Species == "agrifolia")
table(d.Qlob$Year, d.Qlob$Granary)
table(d.Qagr$Year, d.Qagr$Granary)
```

We create exploratory plots to see if any obvious structure appears.
Relatively few seed movements are longer than 500 m:

```{r}
sum(d.Qlob$Distance > 500)
sum(d.Qagr$Distance > 500)
```

so for clarity we exclude outliers from these plots.  To reduce overplotting
and give us a better sense of acorn numbers at each distance, we also jitter
the y-position of the points just a bit.

```{r, fig.width = 5, fig.height = 5}
opa <- par(mfcol = c(2, 1), cex = 0.8, mar = c(3, 3, 0, 0), las = 1, 
           mgp = c(2, 0.5, 0), tcl = -0.3)
stripchart(Distance ~ Granary, data = d.Qlob, subset = Year == "2002",
           xlab = "Distance (m)", ylab = "Granary", pch = 1, col = "blue", 
           method = "jitter", jitter = 0.2, xlim = c(0, 500), 
           frame.plot = FALSE)
stripchart(Distance ~ Granary, data = d.Qlob, subset = Year == "2004",
           pch = 1, col = "red", method = "jitter", jitter = 0.2, add = TRUE)
legend("bottomright", legend = c("2002", "2004"), pch = 1, bty = "n", 
       col = c("blue", "red"), title = "Valley oak acorns") 
stripchart(Distance ~ Granary, data = d.Qagr, subset = Year == "2006",
           xlab = "Distance (m)", ylab = "Granary", pch = 1, col = "blue", 
           method = "jitter", jitter = 0.2, xlim = c(0, 500),
           frame.plot = FALSE)
stripchart(Distance ~ Granary, data = d.Qagr, subset = Year == "2007",
           pch = 1, col = "red", method = "jitter", jitter = 0.2, add = TRUE)
legend("bottomright", legend = c("2006", "2007"), pch = 1, bty = "n", 
       col = c("blue", "red"), title = "Live oak acorns") 
par(opa)
```

Seeds moved 0 m (always valley oak) were harvested from the same tree that
hosted the granary.

There do appear to be between-year differences for each oak species, but
clearly there is also a lot of granary-specific structure.  This occurs because
each granary has its own neighbourhood of oak trees at varying distances, and
the territorial acorn woodpeckers are most likely to forage in their specific
neighbourhood and have a neighbourhood-specific collection of seed movement
distances.  The `woodpecker_multiyear` dataset does not include seed source
tree identities, but we can treat each unique distance as the identity of a
unique tree because of the relative sparseness of the trees in the landscape.
Calculating the median distance to seed trees used, we do see a great deal of
variation.

```{r}
with(d.Qlob, unlist(lapply(lapply(split(Distance, Granary), unique), median)))
with(d.Qagr, unlist(lapply(lapply(split(Distance, Granary), unique), median)))
```

We discussed the unusually long acorn movement distances of coast live oak for
granary 140 in Scofield *et al*. (2010).

Because of the variation in distances, a nonparametric test such as the
Mann-Whitney-Wilcoxon test (`wilcox.test`) is preferred to a parametric test
such as `t.test`.

```{r}
wilcox.test(Distance ~ Year, data = d.Qlob)
wilcox.test(Distance ~ Year, data = d.Qagr)
```

The results reveals significant differences for live oak but not valley oak.
However, this approach is unsatisfying because it ignores spatial structure we
can see in the data.  One possibility might be to test for year-to-year
differences for each granary individually.  For brevity we examine just the
p-values for each test:

```{r}
wilcox.p.value <- 
    function(x) wilcox.test(Distance ~ Year, data = x, exact = FALSE)$p.value
round(unlist(lapply(split(d.Qlob, d.Qlob$Granary), wilcox.p.value)), 4)
round(unlist(lapply(split(d.Qagr, d.Qagr$Granary), wilcox.p.value)), 4)
```

This also feels not quite on the mark.  I'm sure we can find or develop a
technique to combine the p-values while taking into account the individual
successes and failures, but it still does not fit the scale of our original
question: Are there *overall* differences in seed movement between high- and
low-crop years?

A better test would consider differences in distances between years while
allowing for our observation that different spatial structure of seed sources
surrounding individual granaries creates differences among granaries in seed
movement distance independent of any year-to-year variation in acorn crop size.
In model terms, a better test would treat year as a fixed effect and granary as
a random effect, akin to a [mixed model][MixedModel].  This was our motivation
for developing `nestedRanksTest`.

[MixedModel]: http://en.wikipedia.org/wiki/Mixed_model

# Using the test

The `nestedRanksTest` takes three variables:

* Continuous response, named `y`
* Treatment factor with exactly two levels, named `x`, this will be coerced to a factor if it is not already
* Grouping factor, named `groups`, this too will be coerced to a factor

There are two interfaces for the test: 

* a formula interface, which may be the simplest to use and takes a formula of the form `y ~ x | groups`
* a default interface, that accepts `y`, `x` and `groups` as separate arguments

The grouping factor may be provided using the `groups =` argument in either the
formula or default interfaces.  This argument can be used when the formula has
the formula `y ~ x`; it is an error to provide a grouping factor twice, even
the same grouping factor, using both the formula and the argument.

```{r, eval = FALSE}
## All valid and identical in results
d.Qlob <- subset(woodpecker_multiyear, Species == "lobata")
result <- nestedRanksTest(Distance ~ Year | Granary, data = d.Qlob)
result <- nestedRanksTest(Distance ~ Year, groups = Granary, data = d.Qlob)
result <- nestedRanksTest(Year, Distance, Granary, data = d.Qlob)
result <- with(d.Qlob, nestedRanksTest(y = Distance, x = Year, groups = Granary))
##
## An error, grouping specified twice
result <- nestedRanksTest(Distance ~ Year | Granary, groups = Granary, data = d.Qlob)
## An error, no grouping specified
result <- nestedRanksTest(Distance ~ Year, Distance, data = d.Qlob)
```

* Weights, why?  
* Calculation of weights.
* Appearance in htest_boot
* Function for calculating weights.
* Calculation of MWW statistic.
* Bootstrap procedure.


```{r}
result.Ql <- nestedRanksTest(Distance ~ Year | Granary, data = d.Qlob, n.iter = 2000)
print(result.Ql)
result.Qa <- nestedRanksTest(Distance ~ Year | Granary, data = d.Qagr, n.iter = 2000)
print(result.Ql)
```

We can also plot the results:

```{r, fig.width = 6, fig.height = 3}
plot(result.Ql)
```

This shows the default plot format.  The titles, colours and line styles may be modified in `plot`.

```{r, fig.width = 6, fig.height = 3}
plot(result.Qa, main = "Quercus agrifolia", col = "lightgreen", 
     p.col = "brown4", p.lty = 1, mar = c(3, 2, 2, 0), mgp = c(2, 0.5, 0), 
     cex = 0.8)
```

# Return value

The return value of `nestedRanksTest` is a list of class `"htest_boot"`, a class which extends the often-used class `"htest"` by including some members that allow for further description of the bootstrap process and null distribution.  Components marked with `"*"` are additions to `"htest"`.


| Component |  Contents |
| ----------|---------- |
| `statistic` | the value of the observed Z-score. |
| `p.value` | the p-value for the test. |
| `alternative` | a character string describing the alternative hypothesis. |
| `method` | a character string indicating the nested ranks test performed. |
| `data.name` | a character string giving the name(s) of the data.. |
| `bad.obs` | the number of observations in the data excluded because of `NA` values. |
| `null.values` | quantiles of the null distribution used for calculating the p-value. |
| `n.iter*` | the number of bootstrap iterations used for generating the null distribution. |
| `weights*` | the weights for groups, calculated by `nestedRanksTest_weights`. |
| `null.distribution*` | vector containing null distribution of Z-scores, with `statistic` the last value. |

The structure of the class is:

```{r}
str(result.Ql)
```

There is also a `plot` method defined for class `"htest_boot"`, which prints a diagnostic figure showing the null distribution and observed value.

We first described this test in [Thompson _et al._ 2014 _Movement Ecology_
2:12](http://www.movementecologyjournal.com/content/2/1/12).

# References

Scofield, D. G., Sork, V. L., and Smouse, P. E.  (2010)  Influence of acorn woodpecker social behaviour on transport of coast live oak (*Quercus agrifolia*) acorns in a southern California oak savanna.  *Journal of Ecology* **98**: 561-572.

Thompson, P. G., Smouse, P. E., Scofield, D. G., and Sork, V. L. (2014)  What seeds tell us about birds: a multi-year analysis of acorn woodpecker foraging movements.  *Movement Ecology* **2**: 12. <http://www.movementecologyjournal.com/content/2/1/12>
