---
title: "Using nestedRanksTest"
author: "Douglas G. Scofield"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using nestedRanksTest}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", fig.show = "hold")
```

# Motivation for developing the test

Together with my colleagues Pamela Thompson, Peter Smouse and Victoria Sork, we
were examining year-to-year differences in acorn movement by acorn woodpeckers
in an oak savannah in central California.  Drs. Sork and Smouse have
collaborated for several years studying patterns of genetic diversity in oak
populations, unraveling the ways in which genetic diversity moves around the
landscape via dispersal of pollen and seeds, and developing analytic methods to
study these topics and help others do so as well.  I did a post-doc in Dr.
Sork's lab, publishing several papers together.  We continued to develop
methods for characterising dispersal in plant populations.  All the methods I
was involved in developing have been described and used in our published
research, and all have been implemented in R.  Source code for these
methods was always available via Dr. Sork's lab website and later via my own
collection of [Github repositories](https://github.com/douglasgscofield), but it has been only recently that I have begun releasing this code via R packages.

Acorn woodpeckers are highly social,
and each social group maintains its own granary in which it stores acorns.  The
woodpeckers are highly territorial and occupy relatively stable territories,
each containing a number of mature oak trees at varying distances from the
granary.  Because each granary has its own neighbourhood of oak trees, it would
not be a very precise test to look for overall differences in acorn movement
within the entire savannah, on the other hand looking for differences within
each granary individually would have required greater than practical sample
sizes to have sufficient statistical power.  We chose instead to test whether
the distance ranks differ between years within each granary, and combine
results across granaries for an aggregate between-year test.


We first described this test in [Thompson _et al._ 2014 _Movement Ecology_
2:12](http://www.movementecologyjournal.com/content/2/1/12).

What was our motivation for why we expected the years to be different?

Table with the data counts:

```{r}
library(nestedRanksTest)
data(woodpecker_multiyear)
d.Qlobata <- subset(woodpecker_multiyear, Species == "lobata")
d.Qagrifolia <- subset(woodpecker_multiyear, Species == "agrifolia")
table(d.Qlobata$Year, d.Qlobata$Granary)
table(d.Qagrifolia$Year, d.Qagrifolia$Granary)
```

Relatively few seed movements are longer than 500 m:

```{r}
sum(d.Qlobata$Distance > 500)
sum(d.Qagrifolia$Distance > 500)
```

so for clarity we exclude these from our exploratory plots using `xlim = c(0,
500)`.  Seeds moved 0 m were harvested from the same tree that is hosting the
granary.  *Q. agrifolia* never host granaries.

```{r, fig.width = 5, fig.height = 2.5}
opa <- par(mar = c(3, 3, 0, 0), las = 1)
stripchart(Distance ~ Granary, data = d.Qlobata, subset = Year == "2002",
           xlab = "Distance (m)", ylab = "Granary", pch = 1, col = "blue", 
           method = "jitter", jitter = 0.2, xlim = c(0, 500), 
           frame.plot = FALSE)
stripchart(Distance ~ Granary, data = d.Qlobata, subset = Year == "2004",
           pch = 1, col = "red", method = "jitter", jitter = 0.2, add = TRUE)
legend("bottomright", legend = c("2002", "2004"), pch = 1, bty = "n", 
       col = c("blue", "red"), title = "Q. lobata acorn movement") 
stripchart(Distance ~ Granary, data = d.Qagrifolia, subset = Year == "2006",
           xlab = "Distance (m)", ylab = "Granary", pch = 1, col = "blue", 
           method = "jitter", jitter = 0.2, xlim = c(0, 500),
           frame.plot = FALSE)
stripchart(Distance ~ Granary, data = d.Qagrifolia, subset = Year == "2007",
           pch = 1, col = "red", method = "jitter", jitter = 0.2, add = TRUE)
legend("bottomright", legend = c("2006", "2007"), pch = 1, bty = "n", 
       col = c("blue", "red"), title = "Q. agrifolia acorn movement") 
par(opa)
```

Clearly there is a lot of spatial structure to the data in each year; this is
because each granary has its own neighbourhood of oak trees at varying
distances.  Treating each unique distance as a unique seed tree, we calculate
mean distance to seed trees around each granary.

```{r}
mean.rounded <- function(x, digits = 1) round(mean(x), digits)
with(d.Qlobata, unlist(lapply(lapply(split(Distance, Granary), unique), mean.rounded)))
with(d.Qagrifolia, unlist(lapply(lapply(split(Distance, Granary), unique), mean.rounded)))
```

Forging ahead, we perform Mann-Whitney-Wilcoxon test for rank differences
between years:

```{r}
wilcox.test(Distance ~ Year, data = d.Qlobata)
wilcox.test(Distance ~ Year, data = d.Qagrifolia)
```

While the test result for *Q. agrifolia* is highly significant, nonetheless it
is unsatisfying to stop there while ignore spatial structure that we know
exists.  A first step toward addressing this could be to apply `wilcox.test` to
each granary individually.  For *Q. lobata*:

```{r}
wilcox.p.value <- function(x) wilcox.test(Distance ~ Year, data = x, exact = FALSE)$p.value
# here we split the dataframe by granary
round(unlist(lapply(split(d.Qlobata, d.Qlobata$Granary), wilcox.p.value)), 4)
round(unlist(lapply(split(d.Qagrifolia, d.Qagrifolia$Granary), wilcox.p.value)), 4)
```

This also feels not quite on the mark.  We can tally up successes and failures
but it still does not seem like an answer that fits the scale of our original
question: are there overall differences in seed movement between high- and
low-crop years?  A better test would consider differences in distances between
years while allowing for differences in spatial structure of seed sources among
granaries, in other words would treat year as a fixed effect and granary as a
random effect.  Hence our motivation for developing this test.

```{r}
(result.Ql <- nestedRanksTest(Distance ~ Year | Granary, data = d.Qlobata, n.iter = 1000))
(result.Qa <- nestedRanksTest(Distance ~ Year | Granary, data = d.Qagrifolia, n.iter = 1000))
```

The return value of `nestedRanksTest` is a list of class `"htest_boot"`, a class which extends the often-used class `"htest"` by including some members that allow for further description of the bootstrap process and null distribution.  Components marked with `"*"` are additions to `"htest"`.


| Component |  Contents |
| ----------|---------- |
| `statistic` | the value of the observed Z-score. |
| `p.value` | the p-value for the test. |
| `alternative` | a character string describing the alternative hypothesis. |
| `method` | a character string indicating the nested ranks test performed. |
| `data.name` | a character string giving the name(s) of the data.. |
| `bad.obs` | the number of observations in the data excluded because of `NA` values. |
| `null.values` | quantiles of the null distribution used for calculating the p-value. |
| `n.iter*` | the number of bootstrap iterations used for generating the null distribution. |
| `weights*` | the weights for groups, calculated by `nestedRanksTest_weights`. |
| `null.distribution*` | vector containing null distribution of Z-scores, with `statistic` the last value. |

The structure of the class is:

```{r}
str(result.Ql)
```

There is also a `plot` method defined for class `"htest_boot"`, which prints a diagnostic figure showing the null distribution and observed value.

```{r, fig.width = 5, fig.height = 4}
opa = par(mfrow = c(2, 1), mar = c(4, 3, 2, 0), mgp = c(2, 0.5, 0), cex = 0.8)
plot(result.Ql)
plot(result.Qa, main = "Quercus agrifolia", col = "lightgreen", p.col = "brown4", p.lty = 1)
par(opa)
```
